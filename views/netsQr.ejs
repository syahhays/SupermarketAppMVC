<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title || 'NETS QR' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .qr-box { max-width: 420px; margin: 0 auto; }
    .qr-img { width: 100%; height: auto; border: 1px solid #eee; border-radius: 8px; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="container my-5">
    <div class="text-center mb-4">
      <h2><%= title || 'Scan to Pay' %></h2>
      <p class="text-muted">Use your NETS app to scan the QR code.</p>
    </div>

    <div class="card p-4 qr-box">
      <img class="qr-img" src="<%= qrCodeUrl %>" alt="NETS QR Code">
      <div class="mt-3 d-flex justify-content-between">
        <span>Total</span>
        <strong>$<%= Number(total || 0).toFixed(2) %></strong>
      </div>
      <div class="mt-2 d-flex justify-content-between">
        <span>Time left</span>
        <strong id="qr-timer"><%= timer || 300 %></strong>
      </div>
      <div class="mt-3">
        <div class="text-muted small">Payment status</div>
        <div id="nets-status" class="fw-semibold">Checking...</div>
        <div id="nets-status-detail" class="text-muted small"></div>
      </div>
      <div class="mt-2 text-muted small">
        Ref: <%= txnRetrievalRef %>
      </div>
    </div>

    <div class="text-center mt-4">
      <a class="btn btn-outline-secondary" href="/checkout">Back to checkout</a>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script>
    (function () {
      var el = document.getElementById('qr-timer');
      if (!el) return;
      var remaining = parseInt(el.textContent, 10);
      if (isNaN(remaining) || remaining <= 0) return;
      var interval = setInterval(function () {
        remaining -= 1;
        el.textContent = remaining;
        if (remaining <= 0) clearInterval(interval);
      }, 1000);
    })();

    (function () {
      var statusEl = document.getElementById('nets-status');
      var detailEl = document.getElementById('nets-status-detail');
      var txnRef = "<%= txnRetrievalRef %>";
      var courseInitId = "<%= courseInitId %>";

      if (!statusEl || !txnRef) return;

      var stopped = false;

      function setStatus(text, detail) {
        statusEl.textContent = text || 'Unknown';
        if (detailEl) {
          detailEl.textContent = detail || '';
        }
      }

      async function pollStatus() {
        if (stopped) return;
        try {
          var url = '/nets-qr/status?txnRetrievalRef=' + encodeURIComponent(txnRef);
          if (courseInitId) {
            url += '&courseInitId=' + encodeURIComponent(courseInitId);
          }
          var res = await fetch(url);
          var data = await res.json();

          if (!res.ok || !data.ok) {
            setStatus('Pending', data.error || 'Waiting for status update...');
            return;
          }

          var statusPayload = data.status || {};
          var result = statusPayload.result && statusPayload.result.data ? statusPayload.result.data : statusPayload.result || statusPayload;
          var code = result.response_code || result.responseCode || 'N.A.';
          var txnStatus = result.txn_status || result.txnStatus || result.status || 'PENDING';

          setStatus('Latest: ' + txnStatus, 'Response code: ' + code);

          if (data.paid && data.orderId) {
            stopped = true;
            window.location.href = '/orders/' + data.orderId;
          }
        } catch (e) {
          setStatus('Pending', 'Waiting for status update...');
        }
      }

      pollStatus();
      setInterval(pollStatus, 3000);
    })();
  </script>
</body>
</html>
