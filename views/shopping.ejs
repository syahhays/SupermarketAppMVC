<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supermarket Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .qty-input { width: 70px; }
    .add-btn { min-width: 110px; }
    footer { margin-top: 50px; padding: 20px 0; text-align: center; color: #777; }
  </style>
</head>

<body>
  <%- include('partials/navbar') %>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Supermarket Shop</h1>

      <!-- Search form (use input-group for consistent sizing) -->
      <form class="d-flex align-items-center position-relative" action="/shopping" method="GET" role="search" style="min-width:380px;">
        <div class="input-group input-group-sm" style="width:100%;">
          <input
            id="product-search"
            class="form-control"
            type="search"
            name="q"
            placeholder="Search products..."
            autocomplete="off"
            value="<%= query || '' %>">

          <button class="btn btn-outline-secondary" type="submit">Search</button>
        </div>

        <!-- suggestions dropdown: positioned under the input-group -->
        <ul id="search-suggestions" class="list-group position-absolute" style="z-index:2000; top:44px; left:0; right:0; display:none;"></ul>
      </form>
    </div>

    <% if (products && products.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th scope="col">Image</th>
              <th scope="col">Product</th>
              <th scope="col">Price ($)</th>
              <th scope="col">Available Qty</th>
              <th scope="col" class="text-end" style="width: 220px;">Add to Cart</th>
            </tr>
          </thead>

          <tbody>
            <% products.forEach(product => { %>
              <tr>
                <td style="width: 80px;">
                  <% if (product.image) { %>
                    <img src="/images/<%= product.image %>" alt="<%= product.productName %>" class="img-fluid" style="max-height: 60px;">
                  <% } else { %>
                    <span class="text-muted">No image</span>
                  <% } %>
                </td>

                <td><strong><%= product.productName %></strong></td>
                <td><%= product.price.toFixed ? product.price.toFixed(2) : product.price %></td>
                <td><%= product.quantity %></td>

                <td class="text-end">
                  <form action="/add-to-cart/<%= product.id %>" method="POST" class="d-flex justify-content-end gap-2">
                    <input type="number" name="quantity" class="form-control form-control-sm qty-input" value="1" min="1" max="<%= product.quantity %>">
                    <button type="submit" class="btn btn-primary btn-sm add-btn">Add to Cart</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

    <% } else { %>
      <p class="text-muted">No products available.</p>
    <% } %>
  </div>

  <footer>Supermarket App</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const input = document.getElementById('product-search');
      const box = document.getElementById('search-suggestions');
      let activeIndex = -1;
      let items = [];
      let timer;

      function debounce(fn, ms){ clearTimeout(timer); timer = setTimeout(fn, ms); }

      function highlight(name, q){
        if (!q) return name;
        const idx = name.toLowerCase().indexOf(q.toLowerCase());
        if (idx === -1) return name;
        const before = name.slice(0, idx);
        const match = name.slice(idx, idx + q.length);
        const after = name.slice(idx + q.length);
        return `${escapeHtml(before)}<strong>${escapeHtml(match)}</strong>${escapeHtml(after)}`;
      }

      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
      }

      function render(list, q){
        items = list || [];
        if (!items.length) { box.style.display = 'none'; box.innerHTML = ''; return; }
        box.innerHTML = items.map((it, i) =>
          `<li data-index="${i}" class="list-group-item list-group-item-action" style="cursor:pointer">${highlight(it.productName, q)}</li>`
        ).join('');
        box.style.display = 'block';
      }

      async function fetchSuggestions(q){
        if (!q) { render([], ''); return; }
        try {
          const res = await fetch('/api/products/suggest?q=' + encodeURIComponent(q));
          if (!res.ok) return;
          const data = await res.json();
          render(data, q);
        } catch(e){ console.error(e); }
      }

      input.addEventListener('input', (e) => {
        const q = e.target.value.trim();
        debounce(() => fetchSuggestions(q), 200);
      });

      input.addEventListener('keydown', (e) => {
        const nodes = box.querySelectorAll('li');
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIndex = Math.min(activeIndex + 1, nodes.length - 1); updateActive(nodes); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIndex = Math.max(activeIndex - 1, 0); updateActive(nodes); }
        else if (e.key === 'Enter') { if (activeIndex >= 0 && nodes[activeIndex]) { e.preventDefault(); selectItem(activeIndex); } }
        else if (e.key === 'Escape') { box.style.display = 'none'; }
      });

      function updateActive(nodes){ nodes.forEach(n => n.classList.remove('active')); if (nodes[activeIndex]) nodes[activeIndex].classList.add('active'); }
      function selectItem(index){ const it = items[index]; if (!it) return; window.location.href = '/product/' + it.id; }

      box.addEventListener('click', (e) => { const li = e.target.closest('li'); if (!li) return; const idx = parseInt(li.getAttribute('data-index'), 10); selectItem(idx); });
      document.addEventListener('click', (e) => { if (!input.contains(e.target) && !box.contains(e.target)) { box.style.display = 'none'; } });
    })();
  </script>
</body>
</html>