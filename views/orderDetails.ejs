<!DOCTYPE html>
<html lang="en">
<head>
  <title>Order <%= orderId %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
  <style>
    :root {
      --invoice-paper: #ffffff;
      --invoice-ink: #1f2328;
      --invoice-muted: #6b7078;
      --invoice-line: #e6e6e6;
    }
    body { font-family: Arial, sans-serif; }
    .invoice-wrap {
      background: var(--invoice-paper);
      border: 1px solid var(--invoice-line);
      border-radius: 14px;
      padding: 36px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .invoice-title,
    .invoice-mark {
      font-family: inherit;
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.2px;
      color: var(--invoice-ink);
      margin: 0;
    }
    .invoice-meta {
      color: var(--invoice-muted);
      font-size: 14px;
    }
    .invoice-table thead th {
      background: transparent;
      color: var(--invoice-ink);
      border-bottom: 2px solid var(--invoice-ink);
      font-weight: 600;
    }
    .invoice-table tbody td {
      border-bottom: 1px solid var(--invoice-line);
    }
    .invoice-totals td {
      padding: 6px 0;
    }
    .invoice-total-strong {
      font-size: 22px;
      font-weight: 700;
      color: var(--invoice-ink);
    }
    @media (max-width: 768px) {
      .invoice-wrap { padding: 20px; }
      .invoice-title,
      .invoice-mark {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

  <%- include('partials/navbar') %>

  <div class="container my-5">
    <div class="invoice-wrap">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div class="invoice-mark">Groceria</div>
        <div class="text-end">
          <div class="invoice-title">INVOICE</div>
          <div class="invoice-meta">Invoice No. <%= orderId %></div>
          <div class="invoice-meta"><%= new Date().toLocaleDateString() %></div>
        </div>
      </div>

      <hr class="my-4" />

      <div class="row g-4">
        <div class="col-md-7">
          <div class="fw-semibold text-uppercase small text-muted">Billed To</div>
          <div class="mt-2">
            <div class="fw-semibold"><%= user && user.username ? user.username : 'Customer' %></div>
            <div class="invoice-meta"><%= user && user.email ? user.email : '' %></div>
            <div class="invoice-meta"><%= user && user.address ? user.address : '' %></div>
            <div class="invoice-meta"><%= user && user.contact_number ? user.contact_number : '' %></div>
          </div>
        </div>
        <div class="col-md-5 text-md-end">
          <div class="fw-semibold text-uppercase small text-muted">Order</div>
          <div class="mt-2">
            <div class="invoice-meta">Order ID: <%= orderId %></div>
            <div class="invoice-meta">Payment: <%= order && order.status ? order.status : (items && items.length ? 'Paid' : 'Pending') %></div>
            <% if (payment && payment.provider) { %>
              <div class="invoice-meta">Method: <%= payment.provider %></div>
            <% } %>
            <% if (payment && payment.refunded_at) { %>
              <div class="invoice-meta">Refunded: <%= payment.refunded_at %></div>
            <% } %>
            <% if (payment && payment.refund_ref) { %>
              <div class="invoice-meta">Refund ref: <%= String(payment.refund_ref).slice(0, 12) %>...</div>
            <% } %>
          </div>
        </div>
      </div>

      <table class="table invoice-table mt-4">
        <thead>
          <tr>
            <th>Item</th>
            <th class="text-center">Quantity</th>
            <th class="text-end">Unit Price</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          <% items.forEach(i => { %>
            <tr>
              <td><%= i.productName %></td>
              <td class="text-center"><%= i.quantity %></td>
              <td class="text-end">$<%= Number(i.price).toFixed(2) %></td>
              <td class="text-end">$<%= (Number(i.price) * i.quantity).toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <div class="row justify-content-end">
        <div class="col-md-5">
          <table class="table table-borderless invoice-totals">
            <tbody>
              <tr>
                <td class="text-end text-muted">Subtotal</td>
                <td class="text-end">$<%= Number(subtotal || 0).toFixed(2) %></td>
              </tr>
              <tr>
                <td class="text-end text-muted">Tax</td>
                <td class="text-end">$<%= Number(tax || 0).toFixed(2) %></td>
              </tr>
              <tr>
                <td class="text-end text-muted">Shipping</td>
                <td class="text-end">$<%= Number(shipping || 0).toFixed(2) %></td>
              </tr>
              <tr class="border-top">
                <th class="text-end">Grand Total</th>
                <th class="text-end invoice-total-strong">$<%= Number(total || 0).toFixed(2) %></th>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="mt-4">
        <% if (order && order.status === 'PAID') { %>
          <% if (!refundRequest || refundRequest.status === 'REJECTED') { %>
            <form method="POST" action="/orders/<%= orderId %>/refund-request">
              <div class="mb-2 fw-semibold">Request a refund</div>
              <div class="mb-2">
                <textarea class="form-control" name="reason" rows="3" placeholder="Reason for refund" required></textarea>
              </div>
              <button type="submit" class="btn btn-warning">Submit Refund Request</button>
            </form>
          <% } else { %>
            <div class="alert alert-info">
              Refund request status: <strong><%= refundRequest.status %></strong>
              <% if (refundRequest.admin_note) { %>
                <div class="mt-1 text-muted">Admin note: <%= refundRequest.admin_note %></div>
              <% } %>
            </div>
          <% } %>
        <% } %>
      </div>

    </div>

    <a href="/orders" class="btn btn-secondary mt-4">Back to Order History</a>
  </div>

</body>
</html>
